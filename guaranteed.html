<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>guaranteed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# DSL and runtime for Storm topologies"/>
    <meta name="author" content="Eugene Tolmachev"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FsShelter/content/style.css" />
    <link rel="icon"
            type="image/png"
            href="/FsShelter/img/logo.png" />
    <script type="text/javascript" src="/FsShelter/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="https://prolucid.github.io">prolucid</a></li>
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/Prolucid/FsShelter">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/FsShelter/index.html">FsShelter</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h2><a name="Defining-reliable-spouts" class="anchor" href="#Defining-reliable-spouts">Defining reliable spouts</a></h2>
<p><a href="https://storm.apache.org/documentation/Guaranteeing-message-processing.html">Processing guarantees</a> are the biggest selling point of Storm, please see the official docs for the details.
The reliable spout implementation for a source like a peristent queue (RabbitMQ, Kafka, etc) needs to obtain the event id from the source and forward Storm's acks and nacks back to the source.
The obtained Id has to be passed along with the tuple from the spout function:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// data schema for the topology, every case is a unqiue stream</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="t">Schema</span> <span class="o">=</span> 
    | <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="p">Original</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="t">int</span>
    | <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="p">Even</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 9)" onmouseover="showTip(event, 'fs6', 9)" class="t">int</span>
    | <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="p">Odd</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 11)" onmouseover="showTip(event, 'fs6', 11)" class="t">int</span>

<span class="c">// numbers spout - produces messages</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 12)" onmouseover="showTip(event, 'fs9', 12)" class="f">numbers</span> <span onmouseout="hideTip(event, 'fs10', 13)" onmouseover="showTip(event, 'fs10', 13)" class="f">source</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs11', 14)" onmouseover="showTip(event, 'fs11', 14)" class="i">async</span> { 
        <span class="k">let!</span> (<span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="i">number</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 17)" onmouseover="showTip(event, 'fs10', 17)" class="f">source</span>()
        <span class="k">return</span> <span onmouseout="hideTip(event, 'fs14', 18)" onmouseover="showTip(event, 'fs14', 18)" class="p">Some</span>(<span onmouseout="hideTip(event, 'fs12', 19)" onmouseover="showTip(event, 'fs12', 19)" class="i">tupleId</span>, <span onmouseout="hideTip(event, 'fs5', 20)" onmouseover="showTip(event, 'fs5', 20)" class="p">Original</span> (<span onmouseout="hideTip(event, 'fs13', 21)" onmouseover="showTip(event, 'fs13', 21)" class="i">number</span>)) 
    }

<span class="c">// add 1 bolt - consumes and emits messages to either Even or Odd stream</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs15', 22)" onmouseover="showTip(event, 'fs15', 22)" class="f">addOne</span> (<span onmouseout="hideTip(event, 'fs16', 23)" onmouseover="showTip(event, 'fs16', 23)" class="i">input</span>,<span onmouseout="hideTip(event, 'fs17', 24)" onmouseover="showTip(event, 'fs17', 24)" class="f">emit</span>) <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs11', 25)" onmouseover="showTip(event, 'fs11', 25)" class="i">async</span> { 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 26)" onmouseover="showTip(event, 'fs16', 26)" class="i">input</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs5', 27)" onmouseover="showTip(event, 'fs5', 27)" class="p">Original</span> <span onmouseout="hideTip(event, 'fs18', 28)" onmouseover="showTip(event, 'fs18', 28)" class="i">x</span> <span class="k">-&gt;</span> 
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs18', 29)" onmouseover="showTip(event, 'fs18', 29)" class="i">x</span> <span class="o">%</span> <span class="n">2</span> <span class="k">with</span>
            | <span class="n">1</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs7', 30)" onmouseover="showTip(event, 'fs7', 30)" class="p">Even</span> (<span onmouseout="hideTip(event, 'fs18', 31)" onmouseover="showTip(event, 'fs18', 31)" class="i">x</span><span class="o">+</span><span class="n">1</span>)
            | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs8', 32)" onmouseover="showTip(event, 'fs8', 32)" class="p">Odd</span> (<span onmouseout="hideTip(event, 'fs18', 33)" onmouseover="showTip(event, 'fs18', 33)" class="i">x</span><span class="o">+</span><span class="n">1</span>)
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs19', 34)" onmouseover="showTip(event, 'fs19', 34)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs16', 35)" onmouseover="showTip(event, 'fs16', 35)" class="i">input</span>
        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs17', 36)" onmouseover="showTip(event, 'fs17', 36)" class="f">emit</span>
    }

<span class="c">// terminating bolt - consumes messages</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs20', 37)" onmouseover="showTip(event, 'fs20', 37)" class="f">logResult</span> (<span onmouseout="hideTip(event, 'fs21', 38)" onmouseover="showTip(event, 'fs21', 38)" class="f">info</span>,<span onmouseout="hideTip(event, 'fs16', 39)" onmouseover="showTip(event, 'fs16', 39)" class="i">input</span>) <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs11', 40)" onmouseover="showTip(event, 'fs11', 40)" class="i">async</span> { 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 41)" onmouseover="showTip(event, 'fs16', 41)" class="i">input</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs7', 42)" onmouseover="showTip(event, 'fs7', 42)" class="p">Even</span> <span onmouseout="hideTip(event, 'fs18', 43)" onmouseover="showTip(event, 'fs18', 43)" class="i">x</span>
        | <span onmouseout="hideTip(event, 'fs8', 44)" onmouseover="showTip(event, 'fs8', 44)" class="p">Odd</span> <span onmouseout="hideTip(event, 'fs18', 45)" onmouseover="showTip(event, 'fs18', 45)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs21', 46)" onmouseover="showTip(event, 'fs21', 46)" class="f">info</span> (<span onmouseout="hideTip(event, 'fs22', 47)" onmouseover="showTip(event, 'fs22', 47)" class="f">sprintf</span> <span class="s">&quot;Got: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs16', 48)" onmouseover="showTip(event, 'fs16', 48)" class="i">input</span>)
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs19', 49)" onmouseover="showTip(event, 'fs19', 49)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs16', 50)" onmouseover="showTip(event, 'fs16', 50)" class="i">input</span>
    }
</code></pre></td>
</tr>
</table>
<p>Here we mimic an external source and implement all three possible cases: produce a new message, retry a failed one (indefinetely) and ack a successfully processed.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">FsShelter</span><span class="o">.</span><span class="i">Topology</span>

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs23', 51)" onmouseover="showTip(event, 'fs23', 51)" class="t">QueueCmd</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs24', 52)" onmouseover="showTip(event, 'fs24', 52)" class="p">Get</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs25', 53)" onmouseover="showTip(event, 'fs25', 53)" class="t">AsyncReplyChannel</span><span class="o">&lt;</span><span class="i">TupleId</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs6', 54)" onmouseover="showTip(event, 'fs6', 54)" class="t">int</span><span class="o">&gt;</span>
    | <span onmouseout="hideTip(event, 'fs26', 55)" onmouseover="showTip(event, 'fs26', 55)" class="p">Ack</span> <span class="k">of</span> <span class="i">TupleId</span>
    | <span onmouseout="hideTip(event, 'fs27', 56)" onmouseover="showTip(event, 'fs27', 56)" class="p">Nack</span> <span class="k">of</span> <span class="i">TupleId</span>

<span class="c">// faking an external source here</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs28', 57)" onmouseover="showTip(event, 'fs28', 57)" class="i">source</span> <span class="o">=</span> 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs29', 58)" onmouseover="showTip(event, 'fs29', 58)" class="i">rnd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs30', 59)" onmouseover="showTip(event, 'fs30', 59)" class="t">Random</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs31', 60)" onmouseover="showTip(event, 'fs31', 60)" class="v">count</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs32', 61)" onmouseover="showTip(event, 'fs32', 61)" class="f">ref</span> <span class="n">0L</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs33', 62)" onmouseover="showTip(event, 'fs33', 62)" class="i">pending</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 63)" onmouseover="showTip(event, 'fs34', 63)" class="t">Dictionary</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs35', 64)" onmouseover="showTip(event, 'fs35', 64)" class="f">nextId</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs36', 65)" onmouseover="showTip(event, 'fs36', 65)" class="i">Threading</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs37', 66)" onmouseover="showTip(event, 'fs37', 66)" class="t">Interlocked</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs38', 67)" onmouseover="showTip(event, 'fs38', 67)" class="f">Increment</span> <span class="o">&amp;</span><span onmouseout="hideTip(event, 'fs31', 68)" onmouseover="showTip(event, 'fs31', 68)" class="v">count</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs39', 69)" onmouseover="showTip(event, 'fs39', 69)" class="v">contents</span>

    <span onmouseout="hideTip(event, 'fs40', 70)" onmouseover="showTip(event, 'fs40', 70)" class="t">MailboxProcessor</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs41', 71)" onmouseover="showTip(event, 'fs41', 71)" class="f">Start</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs42', 72)" onmouseover="showTip(event, 'fs42', 72)" class="i">inbox</span> <span class="k">-&gt;</span> 
        <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs43', 73)" onmouseover="showTip(event, 'fs43', 73)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs44', 74)" onmouseover="showTip(event, 'fs44', 74)" class="i">nacked</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs11', 75)" onmouseover="showTip(event, 'fs11', 75)" class="i">async</span> { 
                <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs45', 76)" onmouseover="showTip(event, 'fs45', 76)" class="i">cmd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs42', 77)" onmouseover="showTip(event, 'fs42', 77)" class="i">inbox</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs46', 78)" onmouseover="showTip(event, 'fs46', 78)" class="f">Receive</span>()
                <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs43', 79)" onmouseover="showTip(event, 'fs43', 79)" class="f">loop</span> <span class="o">&lt;|</span>
                       <span class="k">match</span> <span onmouseout="hideTip(event, 'fs45', 80)" onmouseover="showTip(event, 'fs45', 80)" class="i">cmd</span>, <span onmouseout="hideTip(event, 'fs44', 81)" onmouseover="showTip(event, 'fs44', 81)" class="i">nacked</span> <span class="k">with</span>
                       | <span onmouseout="hideTip(event, 'fs24', 82)" onmouseover="showTip(event, 'fs24', 82)" class="p">Get</span> <span onmouseout="hideTip(event, 'fs47', 83)" onmouseover="showTip(event, 'fs47', 83)" class="i">rc</span>, [] <span class="k">-&gt;</span>
                            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs48', 84)" onmouseover="showTip(event, 'fs48', 84)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs13', 85)" onmouseover="showTip(event, 'fs13', 85)" class="i">number</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs49', 86)" onmouseover="showTip(event, 'fs49', 86)" class="f">string</span>(<span onmouseout="hideTip(event, 'fs35', 87)" onmouseover="showTip(event, 'fs35', 87)" class="f">nextId</span>()), <span onmouseout="hideTip(event, 'fs29', 88)" onmouseover="showTip(event, 'fs29', 88)" class="i">rnd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs50', 89)" onmouseover="showTip(event, 'fs50', 89)" class="f">Next</span>(<span class="n">0</span>, <span class="n">100</span>)
                            <span onmouseout="hideTip(event, 'fs33', 90)" onmouseover="showTip(event, 'fs33', 90)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 91)" onmouseover="showTip(event, 'fs51', 91)" class="f">Add</span>(<span onmouseout="hideTip(event, 'fs48', 92)" onmouseover="showTip(event, 'fs48', 92)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs13', 93)" onmouseover="showTip(event, 'fs13', 93)" class="i">number</span>)
                            <span onmouseout="hideTip(event, 'fs47', 94)" onmouseover="showTip(event, 'fs47', 94)" class="i">rc</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs52', 95)" onmouseover="showTip(event, 'fs52', 95)" class="f">Reply</span>(<span onmouseout="hideTip(event, 'fs48', 96)" onmouseover="showTip(event, 'fs48', 96)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs13', 97)" onmouseover="showTip(event, 'fs13', 97)" class="i">number</span>)
                            []
                       | <span onmouseout="hideTip(event, 'fs24', 98)" onmouseover="showTip(event, 'fs24', 98)" class="p">Get</span> <span onmouseout="hideTip(event, 'fs47', 99)" onmouseover="showTip(event, 'fs47', 99)" class="i">rc</span>,(<span onmouseout="hideTip(event, 'fs48', 100)" onmouseover="showTip(event, 'fs48', 100)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs13', 101)" onmouseover="showTip(event, 'fs13', 101)" class="i">number</span>)<span class="o">::</span><span onmouseout="hideTip(event, 'fs53', 102)" onmouseover="showTip(event, 'fs53', 102)" class="i">xs</span> <span class="k">-&gt;</span>
                            <span onmouseout="hideTip(event, 'fs33', 103)" onmouseover="showTip(event, 'fs33', 103)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 104)" onmouseover="showTip(event, 'fs51', 104)" class="f">Add</span>(<span class="i">tupleId</span>,<span class="i">number</span>)
                            <span class="i">rc</span><span class="o">.</span><span class="f">Reply</span> (<span class="i">tupleId</span>,<span class="i">number</span>)
                            <span onmouseout="hideTip(event, 'fs53', 105)" onmouseover="showTip(event, 'fs53', 105)" class="i">xs</span>
                       | <span onmouseout="hideTip(event, 'fs26', 106)" onmouseover="showTip(event, 'fs26', 106)" class="p">Ack</span> <span onmouseout="hideTip(event, 'fs54', 107)" onmouseover="showTip(event, 'fs54', 107)" class="i">id</span>, _ <span class="k">-&gt;</span> 
                            <span onmouseout="hideTip(event, 'fs33', 108)" onmouseover="showTip(event, 'fs33', 108)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs55', 109)" onmouseover="showTip(event, 'fs55', 109)" class="f">Remove</span> <span onmouseout="hideTip(event, 'fs54', 110)" onmouseover="showTip(event, 'fs54', 110)" class="i">id</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs56', 111)" onmouseover="showTip(event, 'fs56', 111)" class="f">ignore</span>
                            <span onmouseout="hideTip(event, 'fs44', 112)" onmouseover="showTip(event, 'fs44', 112)" class="i">nacked</span>
                       | <span onmouseout="hideTip(event, 'fs27', 113)" onmouseover="showTip(event, 'fs27', 113)" class="p">Nack</span> <span onmouseout="hideTip(event, 'fs54', 114)" onmouseover="showTip(event, 'fs54', 114)" class="i">id</span>, _ <span class="k">-&gt;</span> 
                            (<span onmouseout="hideTip(event, 'fs54', 115)" onmouseover="showTip(event, 'fs54', 115)" class="i">id</span>,<span onmouseout="hideTip(event, 'fs33', 116)" onmouseover="showTip(event, 'fs33', 116)" class="i">pending</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs54', 117)" onmouseover="showTip(event, 'fs54', 117)" class="i">id</span>])<span class="o">::</span><span onmouseout="hideTip(event, 'fs44', 118)" onmouseover="showTip(event, 'fs44', 118)" class="i">nacked</span>
            }
        <span onmouseout="hideTip(event, 'fs43', 119)" onmouseover="showTip(event, 'fs43', 119)" class="f">loop</span> [])
</code></pre></td>
</tr>
</table>
<h2><a name="Anchoring" class="anchor" href="#Anchoring">Anchoring</a></h2>
<p>In order to provide processing guarantees Storm needs to construct and track the state of entire "tuple tree", which is built out by emitting "anchored" tuples.
FsShelter implements anchoring statically: instead of ad-hoc, as determined by a component, it is a property of the stream <em>leading to</em> an emit.
Consequently the implementation of emit (anchored/unanchored) is determined by the topology graph and completely transparent to the bolt that processes a tuple that will be used as an anchor.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">//define the storm topology</span>
<span class="k">open</span> <span class="i">FsShelter</span><span class="o">.</span><span class="i">DSL</span>

<span class="prep">#nowarn</span> <span class="s">&quot;25&quot;</span> <span class="c">// for stream matching expressions</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs57', 120)" onmouseover="showTip(event, 'fs57', 120)" class="i">sampleTopology</span> <span class="o">=</span> <span class="i">topology</span> <span class="s">&quot;Guaranteed&quot;</span> {
    <span class="k">let</span> <span class="i">s1</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs9', 121)" onmouseover="showTip(event, 'fs9', 121)" class="i">numbers</span>
             <span class="o">|&gt;</span> <span class="i">runReliableSpout</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs58', 122)" onmouseover="showTip(event, 'fs58', 122)" class="i">log</span> <span class="i">cfg</span> () <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs28', 123)" onmouseover="showTip(event, 'fs28', 123)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs59', 124)" onmouseover="showTip(event, 'fs59', 124)" class="i">PostAndAsyncReply</span> <span onmouseout="hideTip(event, 'fs24', 125)" onmouseover="showTip(event, 'fs24', 125)" class="i">Get</span>)  <span class="c">// ignoring logging and cfg available</span>
                                 (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs26', 126)" onmouseover="showTip(event, 'fs26', 126)" class="i">Ack</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs28', 127)" onmouseover="showTip(event, 'fs28', 127)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs60', 128)" onmouseover="showTip(event, 'fs60', 128)" class="i">Post</span>, <span onmouseout="hideTip(event, 'fs27', 129)" onmouseover="showTip(event, 'fs27', 129)" class="i">Nack</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs28', 130)" onmouseover="showTip(event, 'fs28', 130)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs60', 131)" onmouseover="showTip(event, 'fs60', 131)" class="i">Post</span>)
    <span class="k">let</span> <span class="i">b1</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs15', 132)" onmouseover="showTip(event, 'fs15', 132)" class="i">addOne</span>
             <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs58', 133)" onmouseover="showTip(event, 'fs58', 133)" class="i">log</span> <span class="i">cfg</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">tuple</span>,<span class="i">emit</span>)) <span class="c">// pass incoming tuple and emit function</span>
             <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">2</span>
    
    <span class="k">let</span> <span class="i">b2</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs20', 134)" onmouseover="showTip(event, 'fs20', 134)" class="i">logResult</span>
             <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs58', 135)" onmouseover="showTip(event, 'fs58', 135)" class="i">log</span> <span class="i">cfg</span> <span class="k">-&gt;</span>
                            <span class="k">let</span> <span class="i">mylog</span> <span class="o">=</span> <span class="i">Common</span><span class="o">.</span><span class="i">Logging</span><span class="o">.</span><span class="i">asyncLog</span> (<span class="s">&quot;odd.log&quot;</span>)
                            <span class="k">fun</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">mylog</span>,<span class="i">tuple</span>))
             <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">1</span>

    <span class="k">let</span> <span class="i">b3</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs20', 136)" onmouseover="showTip(event, 'fs20', 136)" class="i">logResult</span>
             <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs58', 137)" onmouseover="showTip(event, 'fs58', 137)" class="i">log</span> <span class="i">cfg</span> <span class="k">-&gt;</span> 
                            <span class="k">let</span> <span class="i">mylog</span> <span class="o">=</span> <span class="i">Common</span><span class="o">.</span><span class="i">Logging</span><span class="o">.</span><span class="i">asyncLog</span> (<span class="s">&quot;even.log&quot;</span>) 
                            <span class="k">fun</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">mylog</span>,<span class="i">tuple</span>))
             <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">1</span>

    <span class="k">yield</span> <span class="i">s1</span> <span class="o">==&gt;</span> <span class="i">b1</span> <span class="o">|&gt;</span> <span class="i">shuffle</span><span class="o">.</span><span class="i">on</span> <span onmouseout="hideTip(event, 'fs5', 138)" onmouseover="showTip(event, 'fs5', 138)" class="i">Original</span>  <span class="c">// emit from s1 to b1 on Original stream and anchor immediately following emits to this tuple</span>
    <span class="k">yield</span> <span class="i">b1</span> <span class="o">--&gt;</span> <span class="i">b2</span> <span class="o">|&gt;</span> <span class="i">shuffle</span><span class="o">.</span><span class="i">on</span> <span onmouseout="hideTip(event, 'fs8', 139)" onmouseover="showTip(event, 'fs8', 139)" class="i">Odd</span>       <span class="c">// anchored emit from b1 to b2 on Odd stream </span>
    <span class="k">yield</span> <span class="i">b1</span> <span class="o">--&gt;</span> <span class="i">b3</span> <span class="o">|&gt;</span> <span class="i">shuffle</span><span class="o">.</span><span class="i">on</span> <span onmouseout="hideTip(event, 'fs7', 140)" onmouseover="showTip(event, 'fs7', 140)" class="i">Even</span>      <span class="c">// anchored emit from b1 to b2 on Even stream </span>
}
</code></pre></td>
</tr>
</table>
<p>Resulting topology graph:</p>
<p><img src="svg/Guaranteed.svg" alt="SVG" title="Guaranteed (SVG)" /></p>
<p>The solid lines represent "anchoring" streams and the dotted lines indicate the outer limits of the processing guarantees: a tuple emitted along a dotted line is only anchored if the line leading to it is solid.</p>

<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.Collections</div>
<div class="tip" id="fs3">namespace System.Collections.Generic</div>
<div class="tip" id="fs4">type Schema =<br />&#160;&#160;| Original of int<br />&#160;&#160;| Even of int<br />&#160;&#160;| Odd of int<br /><br />Full name: Guaranteed.Schema</div>
<div class="tip" id="fs5">union case Schema.Original: int -&gt; Schema</div>
<div class="tip" id="fs6">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs7">union case Schema.Even: int -&gt; Schema</div>
<div class="tip" id="fs8">union case Schema.Odd: int -&gt; Schema</div>
<div class="tip" id="fs9">val numbers : source:(unit -&gt; Async&lt;&#39;a * int&gt;) -&gt; Async&lt;(&#39;a * Schema) option&gt;<br /><br />Full name: Guaranteed.numbers</div>
<div class="tip" id="fs10">val source : (unit -&gt; Async&lt;&#39;a * int&gt;)</div>
<div class="tip" id="fs11">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs12">val tupleId : &#39;a</div>
<div class="tip" id="fs13">val number : int</div>
<div class="tip" id="fs14">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs15">val addOne : input:Schema * emit:(Schema -&gt; unit) -&gt; Async&lt;unit&gt;<br /><br />Full name: Guaranteed.addOne</div>
<div class="tip" id="fs16">val input : Schema</div>
<div class="tip" id="fs17">val emit : (Schema -&gt; unit)</div>
<div class="tip" id="fs18">val x : int</div>
<div class="tip" id="fs19">val failwithf : format:Printf.StringFormat&lt;&#39;T,&#39;Result&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.failwithf</div>
<div class="tip" id="fs20">val logResult : info:(string -&gt; unit) * input:Schema -&gt; Async&lt;unit&gt;<br /><br />Full name: Guaranteed.logResult</div>
<div class="tip" id="fs21">val info : (string -&gt; unit)</div>
<div class="tip" id="fs22">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs23">type QueueCmd =<br />&#160;&#160;| Get of AsyncReplyChannel&lt;obj * int&gt;<br />&#160;&#160;| Ack of obj<br />&#160;&#160;| Nack of obj<br /><br />Full name: Guaranteed.QueueCmd</div>
<div class="tip" id="fs24">union case QueueCmd.Get: AsyncReplyChannel&lt;obj * int&gt; -&gt; QueueCmd</div>
<div class="tip" id="fs25">type AsyncReplyChannel&lt;&#39;Reply&gt;<br />member Reply : value:&#39;Reply -&gt; unit<br /><br />Full name: Microsoft.FSharp.Control.AsyncReplyChannel&lt;_&gt;</div>
<div class="tip" id="fs26">union case QueueCmd.Ack: obj -&gt; QueueCmd</div>
<div class="tip" id="fs27">union case QueueCmd.Nack: obj -&gt; QueueCmd</div>
<div class="tip" id="fs28">val source : MailboxProcessor&lt;QueueCmd&gt;<br /><br />Full name: Guaranteed.source</div>
<div class="tip" id="fs29">val rnd : Random</div>
<div class="tip" id="fs30">Multiple items<br />type Random =<br />&#160;&#160;new : unit -&gt; Random + 1 overload<br />&#160;&#160;member Next : unit -&gt; int + 2 overloads<br />&#160;&#160;member NextBytes : buffer:byte[] -&gt; unit<br />&#160;&#160;member NextDouble : unit -&gt; float<br /><br />Full name: System.Random<br /><br />--------------------<br />Random() : unit<br />Random(Seed: int) : unit</div>
<div class="tip" id="fs31">val count : int64 ref</div>
<div class="tip" id="fs32">Multiple items<br />val ref : value:&#39;T -&gt; &#39;T ref<br /><br />Full name: Microsoft.FSharp.Core.Operators.ref<br /><br />--------------------<br />type &#39;T ref = Ref&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.ref&lt;_&gt;</div>
<div class="tip" id="fs33">val pending : Dictionary&lt;string,int&gt;</div>
<div class="tip" id="fs34">Multiple items<br />type Dictionary&lt;&#39;TKey,&#39;TValue&gt; =<br />&#160;&#160;new : unit -&gt; Dictionary&lt;&#39;TKey, &#39;TValue&gt; + 7 overloads<br />&#160;&#160;member Add : key:&#39;TKey * value:&#39;TValue -&gt; unit<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member Comparer : IEqualityComparer&lt;&#39;TKey&gt;<br />&#160;&#160;member ContainsKey : key:&#39;TKey -&gt; bool<br />&#160;&#160;member ContainsValue : value:&#39;TValue -&gt; bool<br />&#160;&#160;member Count : int<br />&#160;&#160;member GetEnumerator : unit -&gt; Enumerator&lt;&#39;TKey, &#39;TValue&gt;<br />&#160;&#160;member GetObjectData : info:SerializationInfo * context:StreamingContext -&gt; unit<br />&#160;&#160;member Item : &#39;TKey -&gt; &#39;TValue with get, set<br />&#160;&#160;...<br />&#160;&#160;nested type Enumerator<br />&#160;&#160;nested type KeyCollection<br />&#160;&#160;nested type ValueCollection<br /><br />Full name: System.Collections.Generic.Dictionary&lt;_,_&gt;<br /><br />--------------------<br />Dictionary() : unit<br />Dictionary(capacity: int) : unit<br />Dictionary(comparer: IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Dictionary(dictionary: IDictionary&lt;&#39;TKey,&#39;TValue&gt;) : unit<br />Dictionary(collection: IEnumerable&lt;KeyValuePair&lt;&#39;TKey,&#39;TValue&gt;&gt;) : unit<br />Dictionary(capacity: int, comparer: IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Dictionary(dictionary: IDictionary&lt;&#39;TKey,&#39;TValue&gt;, comparer: IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Dictionary(collection: IEnumerable&lt;KeyValuePair&lt;&#39;TKey,&#39;TValue&gt;&gt;, comparer: IEqualityComparer&lt;&#39;TKey&gt;) : unit</div>
<div class="tip" id="fs35">val nextId : (unit -&gt; int64)</div>
<div class="tip" id="fs36">namespace System.Threading</div>
<div class="tip" id="fs37">type Interlocked =<br />&#160;&#160;static member Add : location1:int * value:int -&gt; int + 1 overload<br />&#160;&#160;static member CompareExchange : location1:int * value:int * comparand:int -&gt; int + 6 overloads<br />&#160;&#160;static member Decrement : location:int -&gt; int + 1 overload<br />&#160;&#160;static member Exchange : location1:int * value:int -&gt; int + 6 overloads<br />&#160;&#160;static member Increment : location:int -&gt; int + 1 overload<br />&#160;&#160;static member MemoryBarrier : unit -&gt; unit<br />&#160;&#160;static member Read : location:int64 -&gt; int64<br /><br />Full name: System.Threading.Interlocked</div>
<div class="tip" id="fs38">Threading.Interlocked.Increment(location: byref&lt;int64&gt;) : int64<br />Threading.Interlocked.Increment(location: byref&lt;int&gt;) : int</div>
<div class="tip" id="fs39">Ref.contents: int64</div>
<div class="tip" id="fs40">Multiple items<br />type MailboxProcessor&lt;&#39;Msg&gt; =<br />&#160;&#160;interface IDisposable<br />&#160;&#160;new : body:(MailboxProcessor&lt;&#39;Msg&gt; -&gt; Async&lt;unit&gt;) * ?cancellationToken:CancellationToken -&gt; MailboxProcessor&lt;&#39;Msg&gt;<br />&#160;&#160;member Post : message:&#39;Msg -&gt; unit<br />&#160;&#160;member PostAndAsyncReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; Async&lt;&#39;Reply&gt;<br />&#160;&#160;member PostAndReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; &#39;Reply<br />&#160;&#160;member PostAndTryAsyncReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; Async&lt;&#39;Reply option&gt;<br />&#160;&#160;member Receive : ?timeout:int -&gt; Async&lt;&#39;Msg&gt;<br />&#160;&#160;member Scan : scanner:(&#39;Msg -&gt; Async&lt;&#39;T&gt; option) * ?timeout:int -&gt; Async&lt;&#39;T&gt;<br />&#160;&#160;member Start : unit -&gt; unit<br />&#160;&#160;member TryPostAndReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; &#39;Reply option<br />&#160;&#160;...<br /><br />Full name: Microsoft.FSharp.Control.MailboxProcessor&lt;_&gt;<br /><br />--------------------<br />new : body:(MailboxProcessor&lt;&#39;Msg&gt; -&gt; Async&lt;unit&gt;) * ?cancellationToken:Threading.CancellationToken -&gt; MailboxProcessor&lt;&#39;Msg&gt;</div>
<div class="tip" id="fs41">static member MailboxProcessor.Start : body:(MailboxProcessor&lt;&#39;Msg&gt; -&gt; Async&lt;unit&gt;) * ?cancellationToken:Threading.CancellationToken -&gt; MailboxProcessor&lt;&#39;Msg&gt;</div>
<div class="tip" id="fs42">val inbox : MailboxProcessor&lt;QueueCmd&gt;</div>
<div class="tip" id="fs43">val loop : ((string * int) list -&gt; Async&lt;&#39;a&gt;)</div>
<div class="tip" id="fs44">val nacked : (string * int) list</div>
<div class="tip" id="fs45">val cmd : QueueCmd</div>
<div class="tip" id="fs46">member MailboxProcessor.Receive : ?timeout:int -&gt; Async&lt;&#39;Msg&gt;</div>
<div class="tip" id="fs47">val rc : AsyncReplyChannel&lt;obj * int&gt;</div>
<div class="tip" id="fs48">val tupleId : string</div>
<div class="tip" id="fs49">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs50">Random.Next() : int<br />Random.Next(maxValue: int) : int<br />Random.Next(minValue: int, maxValue: int) : int</div>
<div class="tip" id="fs51">Dictionary.Add(key: string, value: int) : unit</div>
<div class="tip" id="fs52">member AsyncReplyChannel.Reply : value:&#39;Reply -&gt; unit</div>
<div class="tip" id="fs53">val xs : (string * int) list</div>
<div class="tip" id="fs54">val id : obj</div>
<div class="tip" id="fs55">Dictionary.Remove(key: string) : bool<br />(extension) IDictionary.Remove&lt;&#39;TKey,&#39;TValue&gt;(key: &#39;TKey, value: byref&lt;&#39;TValue&gt;) : bool<br />Dictionary.Remove(key: string, value: byref&lt;int&gt;) : bool</div>
<div class="tip" id="fs56">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs57">val sampleTopology : obj<br /><br />Full name: Guaranteed.sampleTopology</div>
<div class="tip" id="fs58">val log : value:&#39;T -&gt; &#39;T (requires member Log)<br /><br />Full name: Microsoft.FSharp.Core.Operators.log</div>
<div class="tip" id="fs59">member MailboxProcessor.PostAndAsyncReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; Async&lt;&#39;Reply&gt;</div>
<div class="tip" id="fs60">member MailboxProcessor.Post : message:&#39;Msg -&gt; unit</div>

        </div>
        <div class="span3">
          <img src="/FsShelter/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FsShelter</li>
            <li><a href="/FsShelter/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FsShelter">Get Library via NuGet</a></li>
            <li><a href="http://github.com/Prolucid/FsShelter">Source Code on GitHub</a></li>
            <li><a href="/FsShelter/LICENSE.html">License</a></li>
            <li><a href="/FsShelter/RELEASE_NOTES.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started
            <li><a href="/FsShelter/wordcount.html">WordCount topology</a>
			<ul>
			<li><a href="/FsShelter/wordcount.html#Defining-the-schema">Schema</a></li>
            <li><a href="/FsShelter/wordcount.html#Defining-unreliable-spouts">Spout</a></li>
			<li><a href="/FsShelter/wordcount.html#Defining-bolts">Bolt</a></li>
			<li><a href="/FsShelter/wordcount.html#Using-F-DSL-to-define-a-topology">Topology</a></li>
			<li><a href="/FsShelter/wordcount.html#Submitting-the-topology-for-execution">Submitting for execution</a></li>
            <li><a href="/FsShelter/wordcount.html#Exporting-the-topology-graph">Topology graph</a></li>
			</ul>
			</li>
              <li>
                  <a href="/FsShelter/guaranteed.html">Guaranteed processing</a>
                  <ul>
                      <li><a href="/FsShelter/guaranteed.html#Defining-reliable-spouts">Reliable Spout</a></li>
                      <li><a href="/FsShelter/guaranteed.html#Anchoring">Anchoring</a></li>
                  </ul>
              <li><a href="/FsShelter/schema.html">Schema considerations</a></li>
			</li>

            <li class="nav-header">Documentation</li>
            <li><a href="/FsShelter/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/Prolucid/FsShelter"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
