<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>guaranteed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# DSL and runtime for Storm topologies"/>
    <meta name="author" content="Eugene Tolmachev"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FsShelter/content/style.css" />
    <link rel="icon"
            type="image/png"
            href="/FsShelter/img/logo.png" />
    <script type="text/javascript" src="/FsShelter/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="https://prolucid.github.io">prolucid</a></li>
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/Prolucid/FsShelter">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/FsShelter/index.html">FsShelter</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h2><a name="Defining-reliable-spouts" class="anchor" href="#Defining-reliable-spouts">Defining reliable spouts</a></h2>
<p><a href="https://storm.apache.org/documentation/Guaranteeing-message-processing.html">Processing guarantees</a> are the biggest selling point of Storm, please see the official docs for the details.
The reliable spout implementation for a source like a peristent queue (RabbitMQ, Kafka, etc) needs to obtain the event id from the source and forward Storm's acks and nacks back to the source.
The obtained Id has to be passed along with the tuple from the spout function:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// data schema for the topology, every case is a unqiue stream</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 6)" onmouseover="showTip(event, 'fs2', 6)" class="t">Schema</span> <span class="o">=</span> 
    | <span onmouseout="hideTip(event, 'fs2', 7)" onmouseover="showTip(event, 'fs2', 7)" class="p">Original</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 8)" onmouseover="showTip(event, 'fs2', 8)" class="t">int</span>
    | <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="p">Even</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 10)" onmouseover="showTip(event, 'fs2', 10)" class="t">int</span>
    | <span onmouseout="hideTip(event, 'fs2', 11)" onmouseover="showTip(event, 'fs2', 11)" class="p">Odd</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 12)" onmouseover="showTip(event, 'fs2', 12)" class="t">int</span>

<span class="c">// numbers spout - produces messages</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 13)" onmouseover="showTip(event, 'fs2', 13)" class="f">numbers</span> <span onmouseout="hideTip(event, 'fs2', 14)" onmouseover="showTip(event, 'fs2', 14)" class="f">source</span> <span class="o">=</span>
    <span class="k">let</span> (<span onmouseout="hideTip(event, 'fs2', 15)" onmouseover="showTip(event, 'fs2', 15)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 16)" onmouseover="showTip(event, 'fs2', 16)" class="i">number</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 17)" onmouseover="showTip(event, 'fs2', 17)" class="f">source</span>()
    <span onmouseout="hideTip(event, 'fs2', 18)" onmouseover="showTip(event, 'fs2', 18)" class="p">Some</span>(<span onmouseout="hideTip(event, 'fs2', 19)" onmouseover="showTip(event, 'fs2', 19)" class="i">tupleId</span>, <span onmouseout="hideTip(event, 'fs2', 20)" onmouseover="showTip(event, 'fs2', 20)" class="p">Original</span> (<span onmouseout="hideTip(event, 'fs2', 21)" onmouseover="showTip(event, 'fs2', 21)" class="i">number</span>)) 

<span class="c">// add 1 bolt - consumes and emits messages to either Even or Odd stream</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 22)" onmouseover="showTip(event, 'fs2', 22)" class="f">addOne</span> (<span onmouseout="hideTip(event, 'fs2', 23)" onmouseover="showTip(event, 'fs2', 23)" class="i">input</span>,<span onmouseout="hideTip(event, 'fs2', 24)" onmouseover="showTip(event, 'fs2', 24)" class="f">emit</span>) <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs2', 25)" onmouseover="showTip(event, 'fs2', 25)" class="i">input</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs2', 26)" onmouseover="showTip(event, 'fs2', 26)" class="p">Original</span> <span onmouseout="hideTip(event, 'fs5', 27)" onmouseover="showTip(event, 'fs5', 27)" class="i">x</span> <span class="k">-&gt;</span> 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs5', 28)" onmouseover="showTip(event, 'fs5', 28)" class="i">x</span> <span class="o">%</span> <span class="n">2</span> <span class="k">with</span>
        | <span class="n">1</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 29)" onmouseover="showTip(event, 'fs2', 29)" class="p">Even</span> (<span onmouseout="hideTip(event, 'fs5', 30)" onmouseover="showTip(event, 'fs5', 30)" class="i">x</span><span class="o">+</span><span class="n">1</span>)
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 31)" onmouseover="showTip(event, 'fs2', 31)" class="p">Odd</span> (<span onmouseout="hideTip(event, 'fs5', 32)" onmouseover="showTip(event, 'fs5', 32)" class="i">x</span><span class="o">+</span><span class="n">1</span>)
    | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 33)" onmouseover="showTip(event, 'fs2', 33)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs2', 34)" onmouseover="showTip(event, 'fs2', 34)" class="i">input</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 35)" onmouseover="showTip(event, 'fs2', 35)" class="f">emit</span>

<span class="c">// terminating bolt - consumes messages</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 36)" onmouseover="showTip(event, 'fs2', 36)" class="f">logResult</span> (<span onmouseout="hideTip(event, 'fs2', 37)" onmouseover="showTip(event, 'fs2', 37)" class="f">info</span>,<span onmouseout="hideTip(event, 'fs2', 38)" onmouseover="showTip(event, 'fs2', 38)" class="i">input</span>) <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs2', 39)" onmouseover="showTip(event, 'fs2', 39)" class="i">input</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs2', 40)" onmouseover="showTip(event, 'fs2', 40)" class="p">Even</span> <span onmouseout="hideTip(event, 'fs5', 41)" onmouseover="showTip(event, 'fs5', 41)" class="i">x</span>
    | <span onmouseout="hideTip(event, 'fs2', 42)" onmouseover="showTip(event, 'fs2', 42)" class="p">Odd</span> <span onmouseout="hideTip(event, 'fs5', 43)" onmouseover="showTip(event, 'fs5', 43)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 44)" onmouseover="showTip(event, 'fs2', 44)" class="f">info</span> (<span onmouseout="hideTip(event, 'fs2', 45)" onmouseover="showTip(event, 'fs2', 45)" class="f">sprintf</span> <span class="s">&quot;Got: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs2', 46)" onmouseover="showTip(event, 'fs2', 46)" class="i">input</span>)
    | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 47)" onmouseover="showTip(event, 'fs2', 47)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs2', 48)" onmouseover="showTip(event, 'fs2', 48)" class="i">input</span>
</code></pre></td>
</tr>
</table>
<p>Here we mimic an external source and implement all three possible cases: produce a new message, retry a failed one (indefinetely) and ack a successfully processed.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs2', 49)" onmouseover="showTip(event, 'fs2', 49)" class="i">FsShelter</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 50)" onmouseover="showTip(event, 'fs6', 50)" class="i">Topology</span>

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 51)" onmouseover="showTip(event, 'fs2', 51)" class="t">QueueCmd</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs2', 52)" onmouseover="showTip(event, 'fs2', 52)" class="p">Get</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 53)" onmouseover="showTip(event, 'fs2', 53)" class="t">AsyncReplyChannel</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs2', 54)" onmouseover="showTip(event, 'fs2', 54)" class="t">TupleId</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs2', 55)" onmouseover="showTip(event, 'fs2', 55)" class="t">int</span><span class="o">&gt;</span>
    | <span onmouseout="hideTip(event, 'fs2', 56)" onmouseover="showTip(event, 'fs2', 56)" class="p">Ack</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 57)" onmouseover="showTip(event, 'fs2', 57)" class="t">TupleId</span>
    | <span onmouseout="hideTip(event, 'fs2', 58)" onmouseover="showTip(event, 'fs2', 58)" class="p">Nack</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs2', 59)" onmouseover="showTip(event, 'fs2', 59)" class="t">TupleId</span>

<span class="c">// faking an external source here</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 60)" onmouseover="showTip(event, 'fs2', 60)" class="i">source</span> <span class="o">=</span> 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 61)" onmouseover="showTip(event, 'fs2', 61)" class="i">rnd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 62)" onmouseover="showTip(event, 'fs2', 62)" class="t">Random</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 63)" onmouseover="showTip(event, 'fs2', 63)" class="v">count</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 64)" onmouseover="showTip(event, 'fs2', 64)" class="f">ref</span> <span class="n">0L</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 65)" onmouseover="showTip(event, 'fs2', 65)" class="i">pending</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 66)" onmouseover="showTip(event, 'fs2', 66)" class="t">Dictionary</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 67)" onmouseover="showTip(event, 'fs2', 67)" class="f">nextId</span>() <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 68)" onmouseover="showTip(event, 'fs2', 68)" class="i">Threading</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 69)" onmouseover="showTip(event, 'fs7', 69)" class="t">Interlocked</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 70)" onmouseover="showTip(event, 'fs8', 70)" class="f">Increment</span> <span class="o">&amp;</span><span onmouseout="hideTip(event, 'fs2', 71)" onmouseover="showTip(event, 'fs2', 71)" class="v">count</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 72)" onmouseover="showTip(event, 'fs9', 72)" class="v">contents</span>

    <span onmouseout="hideTip(event, 'fs2', 73)" onmouseover="showTip(event, 'fs2', 73)" class="t">MailboxProcessor</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 74)" onmouseover="showTip(event, 'fs10', 74)" class="f">Start</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 75)" onmouseover="showTip(event, 'fs2', 75)" class="i">inbox</span> <span class="k">-&gt;</span> 
        <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs2', 76)" onmouseover="showTip(event, 'fs2', 76)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs2', 77)" onmouseover="showTip(event, 'fs2', 77)" class="i">nacked</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs2', 78)" onmouseover="showTip(event, 'fs2', 78)" class="i">async</span> { 
                <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs2', 79)" onmouseover="showTip(event, 'fs2', 79)" class="i">cmd</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 80)" onmouseover="showTip(event, 'fs2', 80)" class="i">inbox</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 81)" onmouseover="showTip(event, 'fs11', 81)" class="f">Receive</span>()
                <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs2', 82)" onmouseover="showTip(event, 'fs2', 82)" class="f">loop</span> <span class="o">&lt;|</span>
                       <span class="k">match</span> <span onmouseout="hideTip(event, 'fs2', 83)" onmouseover="showTip(event, 'fs2', 83)" class="i">cmd</span>, <span onmouseout="hideTip(event, 'fs2', 84)" onmouseover="showTip(event, 'fs2', 84)" class="i">nacked</span> <span class="k">with</span>
                       | <span onmouseout="hideTip(event, 'fs2', 85)" onmouseover="showTip(event, 'fs2', 85)" class="p">Get</span> <span onmouseout="hideTip(event, 'fs2', 86)" onmouseover="showTip(event, 'fs2', 86)" class="i">rc</span>, [] <span class="k">-&gt;</span>
                            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 87)" onmouseover="showTip(event, 'fs2', 87)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 88)" onmouseover="showTip(event, 'fs2', 88)" class="i">number</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 89)" onmouseover="showTip(event, 'fs2', 89)" class="f">string</span>(<span onmouseout="hideTip(event, 'fs2', 90)" onmouseover="showTip(event, 'fs2', 90)" class="f">nextId</span>()), <span onmouseout="hideTip(event, 'fs2', 91)" onmouseover="showTip(event, 'fs2', 91)" class="i">rnd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs12', 92)" onmouseover="showTip(event, 'fs12', 92)" class="f">Next</span>(<span class="n">0</span>, <span class="n">100</span>)
                            <span onmouseout="hideTip(event, 'fs2', 93)" onmouseover="showTip(event, 'fs2', 93)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 94)" onmouseover="showTip(event, 'fs13', 94)" class="f">Add</span>(<span onmouseout="hideTip(event, 'fs2', 95)" onmouseover="showTip(event, 'fs2', 95)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 96)" onmouseover="showTip(event, 'fs2', 96)" class="i">number</span>)
                            <span onmouseout="hideTip(event, 'fs2', 97)" onmouseover="showTip(event, 'fs2', 97)" class="i">rc</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 98)" onmouseover="showTip(event, 'fs14', 98)" class="f">Reply</span>(<span onmouseout="hideTip(event, 'fs2', 99)" onmouseover="showTip(event, 'fs2', 99)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 100)" onmouseover="showTip(event, 'fs2', 100)" class="i">number</span>)
                            []
                       | <span onmouseout="hideTip(event, 'fs2', 101)" onmouseover="showTip(event, 'fs2', 101)" class="p">Get</span> <span onmouseout="hideTip(event, 'fs2', 102)" onmouseover="showTip(event, 'fs2', 102)" class="i">rc</span>,(<span onmouseout="hideTip(event, 'fs2', 103)" onmouseover="showTip(event, 'fs2', 103)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 104)" onmouseover="showTip(event, 'fs2', 104)" class="i">number</span>)<span class="o">::</span><span onmouseout="hideTip(event, 'fs2', 105)" onmouseover="showTip(event, 'fs2', 105)" class="i">xs</span> <span class="k">-&gt;</span>
                            <span onmouseout="hideTip(event, 'fs2', 106)" onmouseover="showTip(event, 'fs2', 106)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 107)" onmouseover="showTip(event, 'fs13', 107)" class="f">Add</span>(<span onmouseout="hideTip(event, 'fs2', 108)" onmouseover="showTip(event, 'fs2', 108)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 109)" onmouseover="showTip(event, 'fs2', 109)" class="i">number</span>)
                            <span onmouseout="hideTip(event, 'fs2', 110)" onmouseover="showTip(event, 'fs2', 110)" class="i">rc</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 111)" onmouseover="showTip(event, 'fs2', 111)" class="f">Reply</span> (<span onmouseout="hideTip(event, 'fs2', 112)" onmouseover="showTip(event, 'fs2', 112)" class="i">tupleId</span>,<span onmouseout="hideTip(event, 'fs2', 113)" onmouseover="showTip(event, 'fs2', 113)" class="i">number</span>)
                            <span onmouseout="hideTip(event, 'fs2', 114)" onmouseover="showTip(event, 'fs2', 114)" class="i">xs</span>
                       | <span onmouseout="hideTip(event, 'fs2', 115)" onmouseover="showTip(event, 'fs2', 115)" class="p">Ack</span> <span onmouseout="hideTip(event, 'fs2', 116)" onmouseover="showTip(event, 'fs2', 116)" class="i">id</span>, _ <span class="k">-&gt;</span> 
                            <span onmouseout="hideTip(event, 'fs2', 117)" onmouseover="showTip(event, 'fs2', 117)" class="i">pending</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 118)" onmouseover="showTip(event, 'fs15', 118)" class="f">Remove</span> <span onmouseout="hideTip(event, 'fs2', 119)" onmouseover="showTip(event, 'fs2', 119)" class="i">id</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 120)" onmouseover="showTip(event, 'fs2', 120)" class="f">ignore</span>
                            <span onmouseout="hideTip(event, 'fs2', 121)" onmouseover="showTip(event, 'fs2', 121)" class="i">nacked</span>
                       | <span onmouseout="hideTip(event, 'fs2', 122)" onmouseover="showTip(event, 'fs2', 122)" class="p">Nack</span> <span onmouseout="hideTip(event, 'fs2', 123)" onmouseover="showTip(event, 'fs2', 123)" class="i">id</span>, _ <span class="k">-&gt;</span> 
                            (<span onmouseout="hideTip(event, 'fs2', 124)" onmouseover="showTip(event, 'fs2', 124)" class="i">id</span>,<span onmouseout="hideTip(event, 'fs2', 125)" onmouseover="showTip(event, 'fs2', 125)" class="i">pending</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs2', 126)" onmouseover="showTip(event, 'fs2', 126)" class="i">id</span>])<span class="o">::</span><span onmouseout="hideTip(event, 'fs2', 127)" onmouseover="showTip(event, 'fs2', 127)" class="i">nacked</span>
            }
        <span onmouseout="hideTip(event, 'fs2', 128)" onmouseover="showTip(event, 'fs2', 128)" class="f">loop</span> [])
</code></pre></td>
</tr>
</table>
<h2><a name="Anchoring" class="anchor" href="#Anchoring">Anchoring</a></h2>
<p>In order to provide processing guarantees Storm needs to construct and track the state of entire "tuple tree", which is built out by emitting "anchored" tuples.
FsShelter implements anchoring statically: instead of ad-hoc, as determined by a component, it is a property of the stream <em>leading to</em> an emit.
Consequently the implementation of emit (anchored/unanchored) is determined by the topology graph and completely transparent to the bolt that processes a tuple that will be used as an anchor.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">//define the storm topology</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs2', 129)" onmouseover="showTip(event, 'fs2', 129)" class="i">FsShelter</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 130)" onmouseover="showTip(event, 'fs16', 130)" class="i">DSL</span>

<span class="prep">#nowarn</span> <span class="s">&quot;25&quot;</span> <span class="c">// for stream matching expressions</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 131)" onmouseover="showTip(event, 'fs2', 131)" class="i">sampleTopology</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 132)" onmouseover="showTip(event, 'fs2', 132)" class="f">topology</span> <span class="s">&quot;Guaranteed&quot;</span> {
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 133)" onmouseover="showTip(event, 'fs2', 133)" class="i">s1</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 134)" onmouseover="showTip(event, 'fs2', 134)" class="f">numbers</span>
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 135)" onmouseover="showTip(event, 'fs2', 135)" class="t">Spout</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 136)" onmouseover="showTip(event, 'fs17', 136)" class="f">runReliable</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 137)" onmouseover="showTip(event, 'fs2', 137)" class="f">log</span> <span onmouseout="hideTip(event, 'fs2', 138)" onmouseover="showTip(event, 'fs2', 138)" class="i">cfg</span> () <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 139)" onmouseover="showTip(event, 'fs2', 139)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 140)" onmouseover="showTip(event, 'fs18', 140)" class="f">PostAndReply</span> <span onmouseout="hideTip(event, 'fs2', 141)" onmouseover="showTip(event, 'fs2', 141)" class="p">Get</span>)  <span class="c">// ignoring logging and cfg available</span>
                                  (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs2', 142)" onmouseover="showTip(event, 'fs2', 142)" class="p">Ack</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs2', 143)" onmouseover="showTip(event, 'fs2', 143)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 144)" onmouseover="showTip(event, 'fs19', 144)" class="f">Post</span>, <span onmouseout="hideTip(event, 'fs2', 145)" onmouseover="showTip(event, 'fs2', 145)" class="p">Nack</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs2', 146)" onmouseover="showTip(event, 'fs2', 146)" class="i">source</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs19', 147)" onmouseover="showTip(event, 'fs19', 147)" class="f">Post</span>)
                                  <span onmouseout="hideTip(event, 'fs2', 148)" onmouseover="showTip(event, 'fs2', 148)" class="f">ignore</span>                                       <span class="c">// no deactivation</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 149)" onmouseover="showTip(event, 'fs2', 149)" class="i">b1</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 150)" onmouseover="showTip(event, 'fs2', 150)" class="f">addOne</span>
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 151)" onmouseover="showTip(event, 'fs2', 151)" class="t">Bolt</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 152)" onmouseover="showTip(event, 'fs20', 152)" class="f">run</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 153)" onmouseover="showTip(event, 'fs2', 153)" class="f">log</span> <span onmouseout="hideTip(event, 'fs2', 154)" onmouseover="showTip(event, 'fs2', 154)" class="i">cfg</span> <span onmouseout="hideTip(event, 'fs2', 155)" onmouseover="showTip(event, 'fs2', 155)" class="i">tuple</span> <span onmouseout="hideTip(event, 'fs2', 156)" onmouseover="showTip(event, 'fs2', 156)" class="f">emit</span> <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs2', 157)" onmouseover="showTip(event, 'fs2', 157)" class="i">tuple</span>,<span onmouseout="hideTip(event, 'fs2', 158)" onmouseover="showTip(event, 'fs2', 158)" class="f">emit</span>)) <span class="c">// pass incoming tuple and emit function</span>
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 159)" onmouseover="showTip(event, 'fs2', 159)" class="f">withParallelism</span> <span class="n">2</span>
    
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 160)" onmouseover="showTip(event, 'fs2', 160)" class="i">b2</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 161)" onmouseover="showTip(event, 'fs2', 161)" class="f">logResult</span>
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 162)" onmouseover="showTip(event, 'fs2', 162)" class="t">Bolt</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 163)" onmouseover="showTip(event, 'fs20', 163)" class="f">run</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 164)" onmouseover="showTip(event, 'fs2', 164)" class="f">log</span> <span onmouseout="hideTip(event, 'fs2', 165)" onmouseover="showTip(event, 'fs2', 165)" class="i">cfg</span> <span class="k">-&gt;</span>
                            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 166)" onmouseover="showTip(event, 'fs2', 166)" class="f">mylog</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 167)" onmouseover="showTip(event, 'fs2', 167)" class="i">Common</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 168)" onmouseover="showTip(event, 'fs2', 168)" class="i">Logging</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 169)" onmouseover="showTip(event, 'fs2', 169)" class="i">asyncLog</span> (<span class="s">&quot;odd.log&quot;</span>)
                            <span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 170)" onmouseover="showTip(event, 'fs2', 170)" class="i">tuple</span> <span onmouseout="hideTip(event, 'fs2', 171)" onmouseover="showTip(event, 'fs2', 171)" class="f">emit</span> <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs2', 172)" onmouseover="showTip(event, 'fs2', 172)" class="f">mylog</span>,<span onmouseout="hideTip(event, 'fs2', 173)" onmouseover="showTip(event, 'fs2', 173)" class="i">tuple</span>))
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 174)" onmouseover="showTip(event, 'fs2', 174)" class="f">withParallelism</span> <span class="n">1</span>

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 175)" onmouseover="showTip(event, 'fs2', 175)" class="i">b3</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 176)" onmouseover="showTip(event, 'fs2', 176)" class="f">logResult</span>
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 177)" onmouseover="showTip(event, 'fs2', 177)" class="t">Bolt</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 178)" onmouseover="showTip(event, 'fs20', 178)" class="f">run</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 179)" onmouseover="showTip(event, 'fs2', 179)" class="f">log</span> <span onmouseout="hideTip(event, 'fs2', 180)" onmouseover="showTip(event, 'fs2', 180)" class="i">cfg</span> <span class="k">-&gt;</span> 
                            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs2', 181)" onmouseover="showTip(event, 'fs2', 181)" class="f">mylog</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 182)" onmouseover="showTip(event, 'fs2', 182)" class="i">Common</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 183)" onmouseover="showTip(event, 'fs2', 183)" class="i">Logging</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 184)" onmouseover="showTip(event, 'fs2', 184)" class="i">asyncLog</span> (<span class="s">&quot;even.log&quot;</span>) 
                            <span class="k">fun</span> <span onmouseout="hideTip(event, 'fs2', 185)" onmouseover="showTip(event, 'fs2', 185)" class="i">tuple</span> <span onmouseout="hideTip(event, 'fs2', 186)" onmouseover="showTip(event, 'fs2', 186)" class="f">emit</span> <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs2', 187)" onmouseover="showTip(event, 'fs2', 187)" class="f">mylog</span>,<span onmouseout="hideTip(event, 'fs2', 188)" onmouseover="showTip(event, 'fs2', 188)" class="i">tuple</span>))
             <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 189)" onmouseover="showTip(event, 'fs2', 189)" class="f">withParallelism</span> <span class="n">1</span>

    <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs2', 190)" onmouseover="showTip(event, 'fs2', 190)" class="i">s1</span> <span class="o">==&gt;</span> <span onmouseout="hideTip(event, 'fs2', 191)" onmouseover="showTip(event, 'fs2', 191)" class="i">b1</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 192)" onmouseover="showTip(event, 'fs2', 192)" class="i">shuffle</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 193)" onmouseover="showTip(event, 'fs2', 193)" class="i">on</span> <span onmouseout="hideTip(event, 'fs2', 194)" onmouseover="showTip(event, 'fs2', 194)" class="i">Original</span>  <span class="c">// emit from s1 to b1 on Original stream and anchor immediately following emits to this tuple</span>
    <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs2', 195)" onmouseover="showTip(event, 'fs2', 195)" class="i">b1</span> <span class="o">--&gt;</span> <span onmouseout="hideTip(event, 'fs2', 196)" onmouseover="showTip(event, 'fs2', 196)" class="i">b2</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 197)" onmouseover="showTip(event, 'fs2', 197)" class="i">shuffle</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 198)" onmouseover="showTip(event, 'fs2', 198)" class="i">on</span> <span onmouseout="hideTip(event, 'fs2', 199)" onmouseover="showTip(event, 'fs2', 199)" class="i">Odd</span>       <span class="c">// anchored emit from b1 to b2 on Odd stream </span>
    <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs2', 200)" onmouseover="showTip(event, 'fs2', 200)" class="i">b1</span> <span class="o">--&gt;</span> <span onmouseout="hideTip(event, 'fs2', 201)" onmouseover="showTip(event, 'fs2', 201)" class="i">b3</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 202)" onmouseover="showTip(event, 'fs2', 202)" class="i">shuffle</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 203)" onmouseover="showTip(event, 'fs2', 203)" class="i">on</span> <span onmouseout="hideTip(event, 'fs2', 204)" onmouseover="showTip(event, 'fs2', 204)" class="i">Even</span>      <span class="c">// anchored emit from b1 to b2 on Even stream </span>
}
</code></pre></td>
</tr>
</table>
<p>Resulting topology graph:</p>
<p><img src="svg/Guaranteed.svg" alt="SVG" title="Guaranteed (SVG)" /></p>
<p>The solid lines represent "anchoring" streams and the dotted lines indicate the outer limits of the processing guarantees: a tuple emitted along a dotted line is only anchored if the line leading to it is solid.</p>

<div class="tip" id="fs1">namespace FsShelter</div>
<div class="tip" id="fs2"></div>
<div class="tip" id="fs3">namespace System.Collections</div>
<div class="tip" id="fs4">namespace System.Collections.Generic</div>
<div class="tip" id="fs5">val x : int</div>
<div class="tip" id="fs6">module Topology<br /><br />from FsShelter</div>
<div class="tip" id="fs7">type Interlocked =<br />&#160;&#160;static member Add : location1:int * value:int -&gt; int + 1 overload<br />&#160;&#160;static member CompareExchange : location1:int * value:int * comparand:int -&gt; int + 6 overloads<br />&#160;&#160;static member Decrement : location:int -&gt; int + 1 overload<br />&#160;&#160;static member Exchange : location1:int * value:int -&gt; int + 6 overloads<br />&#160;&#160;static member Increment : location:int -&gt; int + 1 overload<br />&#160;&#160;static member MemoryBarrier : unit -&gt; unit<br />&#160;&#160;static member Read : location:int64 -&gt; int64<br /><br />Full name: System.Threading.Interlocked</div>
<div class="tip" id="fs8">Threading.Interlocked.Increment(location: byref&lt;int64&gt;) : int64<br />Threading.Interlocked.Increment(location: byref&lt;int&gt;) : int</div>
<div class="tip" id="fs9">Ref.contents: int64</div>
<div class="tip" id="fs10">static member MailboxProcessor.Start : body:(MailboxProcessor&lt;&#39;Msg&gt; -&gt; Async&lt;unit&gt;) * ?cancellationToken:Threading.CancellationToken -&gt; MailboxProcessor&lt;&#39;Msg&gt;</div>
<div class="tip" id="fs11">member MailboxProcessor.Receive : ?timeout:int -&gt; Async&lt;&#39;Msg&gt;</div>
<div class="tip" id="fs12">Random.Next() : int<br />Random.Next(maxValue: int) : int<br />Random.Next(minValue: int, maxValue: int) : int</div>
<div class="tip" id="fs13">Dictionary.Add(key: string, value: int) : unit</div>
<div class="tip" id="fs14">member AsyncReplyChannel.Reply : value:&#39;Reply -&gt; unit</div>
<div class="tip" id="fs15">Dictionary.Remove(key: string) : bool<br />(extension) IDictionary.Remove&lt;&#39;TKey,&#39;TValue&gt;(key: &#39;TKey, value: byref&lt;&#39;TValue&gt;) : bool<br />Dictionary.Remove(key: string, value: byref&lt;int&gt;) : bool</div>
<div class="tip" id="fs16">module DSL<br /><br />from FsShelter</div>
<div class="tip" id="fs17">val runReliable : mkArgs:((Multilang.LogLevel -&gt; string -&gt; unit) -&gt; Conf -&gt; &#39;args) -&gt; mkAcker:(&#39;args -&gt; Acker) -&gt; deactivate:(&#39;args -&gt; unit) -&gt; next:Next&lt;&#39;args,(string * &#39;t)&gt; -&gt; Spout&lt;&#39;t&gt;<br /><br />Full name: FsShelter.DSL.Spout.runReliable</div>
<div class="tip" id="fs18">member MailboxProcessor.PostAndReply : buildMessage:(AsyncReplyChannel&lt;&#39;Reply&gt; -&gt; &#39;Msg) * ?timeout:int -&gt; &#39;Reply</div>
<div class="tip" id="fs19">member MailboxProcessor.Post : message:&#39;Msg -&gt; unit</div>
<div class="tip" id="fs20">val run : mkArgs:((Multilang.LogLevel -&gt; string -&gt; unit) -&gt; Conf -&gt; &#39;t -&gt; (&#39;t -&gt; unit) -&gt; &#39;a) -&gt; consume:Consume&lt;&#39;a&gt; -&gt; Bolt&lt;&#39;t&gt;<br /><br />Full name: FsShelter.DSL.Bolt.run</div>

        </div>
        <div class="span3">
          <img src="/FsShelter/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FsShelter</li>
            <li><a href="/FsShelter/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FsShelter">Get Library via NuGet</a></li>
            <li><a href="http://github.com/Prolucid/FsShelter">Source Code on GitHub</a></li>
            <li><a href="/FsShelter/LICENSE.html">License</a></li>
            <li><a href="/FsShelter/RELEASE_NOTES.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started
            <li><a href="/FsShelter/wordcount.html">WordCount topology</a>
			<ul>
			<li><a href="/FsShelter/wordcount.html#Defining-the-schema">Schema</a></li>
            <li><a href="/FsShelter/wordcount.html#Defining-unreliable-spouts">Spout</a></li>
			<li><a href="/FsShelter/wordcount.html#Defining-bolts">Bolt</a></li>
			<li><a href="/FsShelter/wordcount.html#Using-F-DSL-to-define-a-topology">Topology</a></li>
			<li><a href="/FsShelter/wordcount.html#Submitting-the-topology-for-execution">Submitting for execution</a></li>
            <li><a href="/FsShelter/wordcount.html#Exporting-the-topology-graph">Topology graph</a></li>
			</ul>
			</li>
      <li>
          <a href="/FsShelter/guaranteed.html">Guaranteed processing</a>
          <ul>
              <li><a href="/FsShelter/guaranteed.html#Defining-reliable-spouts">Reliable Spout</a></li>
              <li><a href="/FsShelter/guaranteed.html#Anchoring">Anchoring</a></li>
          </ul>
      <li>
          <a href="/FsShelter/self-hosting.html">Self-hosting</a>
			</li>
      <li><a href="/FsShelter/schema.html">Schema considerations</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/FsShelter/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/Prolucid/FsShelter"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
