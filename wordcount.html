<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>wordcount</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# DSL and runtime for Storm topologies"/>
    <meta name="author" content="Eugene Tolmachev"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/FsShelter/content/style.css" />
    <link rel="icon"
            type="image/png"
            href="/FsShelter/img/logo.png" />
    <script type="text/javascript" src="/FsShelter/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="https://prolucid.github.io">prolucid</a></li>
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/Prolucid/FsShelter">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/FsShelter/index.html">FsShelter</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h2><a name="Defining-the-schema" class="anchor" href="#Defining-the-schema">Defining the schema</a></h2>
<p>FsShelter uses F# discriminated unions to statically type streams:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// data schema for the topology, every case is a unqiue stream</span>
<span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="t">Schema</span> <span class="o">=</span> 
    | <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="p">Sentence</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="t">string</span>
    | <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="p">Word</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="t">string</span>
    | <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="p">WordCount</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs4', 8)" onmouseover="showTip(event, 'fs4', 8)" class="t">string</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs7', 9)" onmouseover="showTip(event, 'fs7', 9)" class="t">int64</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Defining-unreliable-spouts" class="anchor" href="#Defining-unreliable-spouts">Defining unreliable spouts</a></h2>
<p>FsShelter spouts can be implemented as "reliable" or "unreliable".
Either implementation is a single function, returning async Option, where None indicates there's nothing to emit from this spout at this moment:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// sentences spout - feeds messages into the topology</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="f">sentences</span> <span onmouseout="hideTip(event, 'fs9', 11)" onmouseover="showTip(event, 'fs9', 11)" class="f">source</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 12)" onmouseover="showTip(event, 'fs10', 12)" class="i">async</span> { <span class="k">return</span> <span onmouseout="hideTip(event, 'fs9', 13)" onmouseover="showTip(event, 'fs9', 13)" class="f">source</span>() <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs3', 14)" onmouseover="showTip(event, 'fs3', 14)" class="p">Sentence</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs11', 15)" onmouseover="showTip(event, 'fs11', 15)" class="p">Some</span> }
</code></pre></td>
</tr>
</table>
<h2><a name="Defining-bolts" class="anchor" href="#Defining-bolts">Defining bolts</a></h2>
<p>A couple of examples of a FsShelter bolts that read a tuple and emit another one:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// split bolt - consumes sentences and emits words</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 16)" onmouseover="showTip(event, 'fs12', 16)" class="f">splitIntoWords</span> (<span onmouseout="hideTip(event, 'fs13', 17)" onmouseover="showTip(event, 'fs13', 17)" class="i">input</span>, <span onmouseout="hideTip(event, 'fs14', 18)" onmouseover="showTip(event, 'fs14', 18)" class="f">emit</span>) <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs10', 19)" onmouseover="showTip(event, 'fs10', 19)" class="i">async</span> { 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs13', 20)" onmouseover="showTip(event, 'fs13', 20)" class="i">input</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs3', 21)" onmouseover="showTip(event, 'fs3', 21)" class="p">Sentence</span> <span onmouseout="hideTip(event, 'fs15', 22)" onmouseover="showTip(event, 'fs15', 22)" class="i">s</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs15', 23)" onmouseover="showTip(event, 'fs15', 23)" class="i">s</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 24)" onmouseover="showTip(event, 'fs16', 24)" class="f">Split</span>([|<span class="s">&#39; &#39;</span>|],<span onmouseout="hideTip(event, 'fs17', 25)" onmouseover="showTip(event, 'fs17', 25)" class="t">StringSplitOptions</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 26)" onmouseover="showTip(event, 'fs18', 26)" class="i">RemoveEmptyEntries</span>) 
                        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs19', 27)" onmouseover="showTip(event, 'fs19', 27)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 28)" onmouseover="showTip(event, 'fs20', 28)" class="f">map</span> <span onmouseout="hideTip(event, 'fs5', 29)" onmouseover="showTip(event, 'fs5', 29)" class="p">Word</span> 
                        <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs19', 30)" onmouseover="showTip(event, 'fs19', 30)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs21', 31)" onmouseover="showTip(event, 'fs21', 31)" class="f">iter</span> <span onmouseout="hideTip(event, 'fs14', 32)" onmouseover="showTip(event, 'fs14', 32)" class="f">emit</span>
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 33)" onmouseover="showTip(event, 'fs22', 33)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs13', 34)" onmouseover="showTip(event, 'fs13', 34)" class="i">input</span>
    }

<span class="c">// count words bolt </span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs23', 35)" onmouseover="showTip(event, 'fs23', 35)" class="f">countWords</span> (<span onmouseout="hideTip(event, 'fs13', 36)" onmouseover="showTip(event, 'fs13', 36)" class="i">input</span>, <span onmouseout="hideTip(event, 'fs24', 37)" onmouseover="showTip(event, 'fs24', 37)" class="f">increment</span>, <span onmouseout="hideTip(event, 'fs14', 38)" onmouseover="showTip(event, 'fs14', 38)" class="f">emit</span>) <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs10', 39)" onmouseover="showTip(event, 'fs10', 39)" class="i">async</span> { 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs13', 40)" onmouseover="showTip(event, 'fs13', 40)" class="i">input</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs5', 41)" onmouseover="showTip(event, 'fs5', 41)" class="p">Word</span> <span onmouseout="hideTip(event, 'fs25', 42)" onmouseover="showTip(event, 'fs25', 42)" class="i">word</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs6', 43)" onmouseover="showTip(event, 'fs6', 43)" class="p">WordCount</span> (<span onmouseout="hideTip(event, 'fs25', 44)" onmouseover="showTip(event, 'fs25', 44)" class="i">word</span>, <span onmouseout="hideTip(event, 'fs24', 45)" onmouseover="showTip(event, 'fs24', 45)" class="f">increment</span> <span onmouseout="hideTip(event, 'fs25', 46)" onmouseover="showTip(event, 'fs25', 46)" class="i">word</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs14', 47)" onmouseover="showTip(event, 'fs14', 47)" class="f">emit</span>
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 48)" onmouseover="showTip(event, 'fs22', 48)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs13', 49)" onmouseover="showTip(event, 'fs13', 49)" class="i">input</span>
    }
</code></pre></td>
</tr>
</table>
<p>And a terminating bolt that reads a tuple, but doesn't emit anything:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// log word count - terminating bolt </span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 50)" onmouseover="showTip(event, 'fs26', 50)" class="f">logResult</span> (<span onmouseout="hideTip(event, 'fs27', 51)" onmouseover="showTip(event, 'fs27', 51)" class="f">log</span>, <span onmouseout="hideTip(event, 'fs13', 52)" onmouseover="showTip(event, 'fs13', 52)" class="i">input</span>) <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs10', 53)" onmouseover="showTip(event, 'fs10', 53)" class="i">async</span> { 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs13', 54)" onmouseover="showTip(event, 'fs13', 54)" class="i">input</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs6', 55)" onmouseover="showTip(event, 'fs6', 55)" class="p">WordCount</span> (<span onmouseout="hideTip(event, 'fs25', 56)" onmouseover="showTip(event, 'fs25', 56)" class="i">word</span>,<span onmouseout="hideTip(event, 'fs28', 57)" onmouseover="showTip(event, 'fs28', 57)" class="i">count</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs27', 58)" onmouseover="showTip(event, 'fs27', 58)" class="f">log</span> (<span onmouseout="hideTip(event, 'fs29', 59)" onmouseover="showTip(event, 'fs29', 59)" class="f">sprintf</span> <span class="s">&quot;</span><span class="pf">%s</span><span class="s">: </span><span class="pf">%d</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs25', 60)" onmouseover="showTip(event, 'fs25', 60)" class="i">word</span> <span onmouseout="hideTip(event, 'fs28', 61)" onmouseover="showTip(event, 'fs28', 61)" class="i">count</span>)
        | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 62)" onmouseover="showTip(event, 'fs22', 62)" class="f">failwithf</span> <span class="s">&quot;unexpected input: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs13', 63)" onmouseover="showTip(event, 'fs13', 63)" class="i">input</span>
    }
</code></pre></td>
</tr>
</table>
<p>We will pass these implementations into the component functions when we put things together in a topology definition.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs30', 64)" onmouseover="showTip(event, 'fs30', 64)" class="f">source</span> <span class="o">=</span> 
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs31', 65)" onmouseover="showTip(event, 'fs31', 65)" class="i">rnd</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs1', 66)" onmouseover="showTip(event, 'fs1', 66)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs32', 67)" onmouseover="showTip(event, 'fs32', 67)" class="t">Random</span>()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs33', 68)" onmouseover="showTip(event, 'fs33', 68)" class="i">sentences</span> <span class="o">=</span> [ <span class="s">&quot;the cow jumped over the moon&quot;</span>
                      <span class="s">&quot;an apple a day keeps the doctor away&quot;</span>
                      <span class="s">&quot;four score and seven years ago&quot;</span>
                      <span class="s">&quot;snow white and the seven dwarfs&quot;</span>
                      <span class="s">&quot;i am at two with nature&quot;</span> ]

    <span class="k">fun</span> () <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs33', 69)" onmouseover="showTip(event, 'fs33', 69)" class="i">sentences</span><span class="o">.</span>[ <span onmouseout="hideTip(event, 'fs31', 70)" onmouseover="showTip(event, 'fs31', 70)" class="i">rnd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 71)" onmouseover="showTip(event, 'fs34', 71)" class="f">Next</span>(<span class="n">0</span>, <span onmouseout="hideTip(event, 'fs33', 72)" onmouseover="showTip(event, 'fs33', 72)" class="i">sentences</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs35', 73)" onmouseover="showTip(event, 'fs35', 73)" class="i">Length</span>) ]

<span class="c">// increment word count and return new value</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs36', 74)" onmouseover="showTip(event, 'fs36', 74)" class="f">increment</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs37', 75)" onmouseover="showTip(event, 'fs37', 75)" class="i">cache</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 76)" onmouseover="showTip(event, 'fs38', 76)" class="i">Collections</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs39', 77)" onmouseover="showTip(event, 'fs39', 77)" class="i">Concurrent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs40', 78)" onmouseover="showTip(event, 'fs40', 78)" class="t">ConcurrentDictionary</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs4', 79)" onmouseover="showTip(event, 'fs4', 79)" class="t">string</span>,<span onmouseout="hideTip(event, 'fs7', 80)" onmouseover="showTip(event, 'fs7', 80)" class="t">int64</span> <span onmouseout="hideTip(event, 'fs41', 81)" onmouseover="showTip(event, 'fs41', 81)" class="t">ref</span><span class="o">&gt;</span>()
    <span class="k">fun</span> <span onmouseout="hideTip(event, 'fs25', 82)" onmouseover="showTip(event, 'fs25', 82)" class="i">word</span> <span class="k">-&gt;</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs42', 83)" onmouseover="showTip(event, 'fs42', 83)" class="v">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs37', 84)" onmouseover="showTip(event, 'fs37', 84)" class="i">cache</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 85)" onmouseover="showTip(event, 'fs43', 85)" class="f">GetOrAdd</span>(<span onmouseout="hideTip(event, 'fs25', 86)" onmouseover="showTip(event, 'fs25', 86)" class="i">word</span>, <span onmouseout="hideTip(event, 'fs41', 87)" onmouseover="showTip(event, 'fs41', 87)" class="f">ref</span> <span class="n">0L</span>) 
        <span onmouseout="hideTip(event, 'fs44', 88)" onmouseover="showTip(event, 'fs44', 88)" class="i">Threading</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 89)" onmouseover="showTip(event, 'fs45', 89)" class="t">Interlocked</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs46', 90)" onmouseover="showTip(event, 'fs46', 90)" class="f">Increment</span> <span class="o">&amp;</span><span onmouseout="hideTip(event, 'fs42', 91)" onmouseover="showTip(event, 'fs42', 91)" class="v">c</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 92)" onmouseover="showTip(event, 'fs47', 92)" class="v">contents</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Using-F-DSL-to-define-a-topology" class="anchor" href="#Using-F-DSL-to-define-a-topology">Using F# DSL to define a topology</a></h2>
<p>A typical (event-streaming) Storm topology is a graph of spouts and bolts connected via streams that can be defined via <code>topology</code> computation expression:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">FsShelter</span><span class="o">.</span><span class="i">DSL</span>
<span class="prep">#nowarn</span> <span class="s">&quot;25&quot;</span> <span class="c">// for stream grouping expressions</span>

<span class="c">//define the storm topology</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs48', 93)" onmouseover="showTip(event, 'fs48', 93)" class="i">sampleTopology</span> <span class="o">=</span> 
    <span class="i">topology</span> <span class="s">&quot;WordCount&quot;</span> { 
        <span class="k">let</span> <span class="i">sentencesSpout</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs8', 94)" onmouseover="showTip(event, 'fs8', 94)" class="i">sentences</span> <span class="o">|&gt;</span> <span class="i">runSpout</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs49', 95)" onmouseover="showTip(event, 'fs49', 95)" class="i">log</span> <span class="i">cfg</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs30', 96)" onmouseover="showTip(event, 'fs30', 96)" class="i">source</span>)        <span class="c">// make arguments: ignoring Storm logging and cfg, passing our source function</span>
        
        <span class="k">let</span> <span class="i">splitBolt</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs12', 97)" onmouseover="showTip(event, 'fs12', 97)" class="i">splitIntoWords</span>
            <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs49', 98)" onmouseover="showTip(event, 'fs49', 98)" class="i">log</span> <span class="i">cfg</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">tuple</span>, <span class="i">emit</span>)) <span class="c">// make arguments: pass incoming tuple and emit function</span>
            <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">2</span>
        
        <span class="k">let</span> <span class="i">countBolt</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs23', 99)" onmouseover="showTip(event, 'fs23', 99)" class="i">countWords</span>
            <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs49', 100)" onmouseover="showTip(event, 'fs49', 100)" class="i">log</span> <span class="i">cfg</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">tuple</span>, <span onmouseout="hideTip(event, 'fs36', 101)" onmouseover="showTip(event, 'fs36', 101)" class="i">increment</span>, <span class="i">emit</span>))
            <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">2</span>
        
        <span class="k">let</span> <span class="i">logBolt</span> <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs26', 102)" onmouseover="showTip(event, 'fs26', 102)" class="i">logResult</span>
            <span class="o">|&gt;</span> <span class="i">runBolt</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs49', 103)" onmouseover="showTip(event, 'fs49', 103)" class="i">log</span> <span class="i">cfg</span> <span class="k">-&gt;</span>                           <span class="c">// make arguments: pass PID-log and incoming tuple </span>
                            <span class="k">let</span> <span class="i">mylog</span> <span class="o">=</span> <span class="i">Common</span><span class="o">.</span><span class="i">Logging</span><span class="o">.</span><span class="i">asyncLog</span> (<span onmouseout="hideTip(event, 'fs50', 104)" onmouseover="showTip(event, 'fs50', 104)" class="i">Diagnostics</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 105)" onmouseover="showTip(event, 'fs51', 105)" class="i">Process</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs52', 106)" onmouseover="showTip(event, 'fs52', 106)" class="i">GetCurrentProcess</span>()<span class="o">.</span><span class="i">Id</span><span class="o">.</span><span class="i">ToString</span>()<span class="o">+</span><span class="s">&quot;_count&quot;</span>)
                            <span class="k">fun</span> <span class="i">tuple</span> <span class="i">emit</span> <span class="k">-&gt;</span> (<span class="i">mylog</span>, <span class="i">tuple</span>))
            <span class="o">|&gt;</span> <span class="i">withParallelism</span> <span class="n">2</span>
        
        <span class="k">yield</span> <span class="i">sentencesSpout</span> <span class="o">--&gt;</span> <span class="i">splitBolt</span> <span class="o">|&gt;</span> <span class="i">shuffle</span><span class="o">.</span><span class="i">on</span> <span onmouseout="hideTip(event, 'fs3', 107)" onmouseover="showTip(event, 'fs3', 107)" class="i">Sentence</span>               <span class="c">// emit from sentencesSpout to splitBolt on Sentence stream, shuffle among target task instances</span>
        <span class="k">yield</span> <span class="i">splitBolt</span> <span class="o">--&gt;</span> <span class="i">countBolt</span> <span class="o">|&gt;</span> <span class="i">group</span><span class="o">.</span><span class="i">by</span> (<span class="k">function</span> <span onmouseout="hideTip(event, 'fs5', 108)" onmouseover="showTip(event, 'fs5', 108)" class="i">Word</span> <span class="i">w</span> <span class="k">-&gt;</span> <span class="i">w</span>)        <span class="c">// emit from splitBolt into countBolt on Word stream, group by word (into the same task instance)</span>
        <span class="k">yield</span> <span class="i">countBolt</span> <span class="o">--&gt;</span> <span class="i">logBolt</span> <span class="o">|&gt;</span> <span class="i">group</span><span class="o">.</span><span class="i">by</span> (<span class="k">function</span> <span onmouseout="hideTip(event, 'fs6', 109)" onmouseover="showTip(event, 'fs6', 109)" class="i">WordCount</span> (<span class="i">w</span>,_) <span class="k">-&gt;</span> <span class="i">w</span>) <span class="c">// emit from countBolt into logBolt on WordCount stream, group by word value</span>
    }
</code></pre></td>
</tr>
</table>
<p>Here we define the graph by declaring the components and connecting them with arrows.
The lambda arguments for the "run" methods privde the opportunity to carry out construction of the arguments that will be passed into the component functions, where:</p>
<ul>
<li><code>log</code> is the Storm log factory</li>
<li><code>cfg</code> is the runtime configuration passed in from Storm</li>
<li><code>tuple</code> is the instance of the schema DU coming in</li>
<li><code>emit</code> is the function to emit another tuple</li>
</ul>
<p><code>log</code> and <code>cfg</code> are fixed once (curried) and as demonstrated in the logBolt's mkArgs lambda, one time-initialization can be carried out by inserting arbitrary code before <code>tuple</code> and <code>emit</code> arguments.
This initialization will not be triggered unless the task execution is actually requested by Storm for this specific instance of the process.</p>
<h2><a name="Submitting-the-topology-for-execution" class="anchor" href="#Submitting-the-topology-for-execution">Submitting the topology for execution</a></h2>
<p>Storm accepts JARs for code distribution and FsShelter provides functions to package our assemblies and upload them to Nimbus.
Once the code is uploaded, Storm needs to be told how to run it and FsShelter has functions that convert the above representation into that of Nimbus API.
Storm then starts the supervising processes across the cluster and spins up a copy of our executable for each task instance in our topology.
FsShelter's <code>Task</code> will perform the handshake that will determine which component a given process instance has been assigned to execute:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs48', 110)" onmouseover="showTip(event, 'fs48', 110)" class="i">sampleTopology</span>
        <span class="o">|&gt;</span> <span class="i">Task</span><span class="o">.</span><span class="i">ofTopology</span>
        <span class="o">|&gt;</span> <span class="i">Task</span><span class="o">.</span><span class="i">run</span> <span class="i">ProtoIO</span><span class="o">.</span><span class="i">start</span> <span class="c">// here we specify which serializer to use when talking to Storm</span>
</code></pre></td>
</tr>
</table>
<p>Then the execution will be handed over to one of the corresponding "dispatchers", which will handle the subsequent interaction between Storm and the component function.</p>
<p>Keep in mind that:</p>
<ul>
<li>STDIN/STDOUT are reserved for communications with Storm and any IO the component is going to do has to go through some other channel (no console logging!).</li>
<li>out of the box Storm only supports JSON multilang, for faster IO consider <a href="https://github.com/prolucid/protoshell">ProtoShell</a>. The serilizer JAR can be bundled along with the submitted topology or deployed in Storm's classpath beforehand.</li>
</ul>
<h2><a name="Exporting-the-topology-graph" class="anchor" href="#Exporting-the-topology-graph">Exporting the topology graph</a></h2>
<p>FsShelter includes a completely customizable GraphViz (dot) export functionality, here's what the word count topology looks like with default renderers:</p>
<p><img src="svg/WordCount.svg" alt="SVG" title="WordCount (SVG)" /></p>
<p>The dotted lines represent "unanchored" streams and the number inside the <code>[]</code> shows the parallelism hint.
This was achived by a simple export to console:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs48', 111)" onmouseover="showTip(event, 'fs48', 111)" class="i">sampleTopology</span> <span class="o">|&gt;</span> <span class="i">DotGraph</span><span class="o">.</span><span class="i">writeToConsole</span>
</code></pre></td>
</tr>
</table>
<p>Followed by further conversion into a desired format, piping the markup into GrapViz:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="bash">mono samples/WordCount/bin/Release/WordCount.exe graph | dot -Tsvg -o build/WordCount.svg
</code></pre></td></tr></table>

<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">type Schema =<br />&#160;&#160;| Sentence of string<br />&#160;&#160;| Word of string<br />&#160;&#160;| WordCount of string * int64<br /><br />Full name: Wordcount.Schema</div>
<div class="tip" id="fs3">union case Schema.Sentence: string -&gt; Schema</div>
<div class="tip" id="fs4">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs5">union case Schema.Word: string -&gt; Schema</div>
<div class="tip" id="fs6">union case Schema.WordCount: string * int64 -&gt; Schema</div>
<div class="tip" id="fs7">Multiple items<br />val int64 : value:&#39;T -&gt; int64 (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int64<br /><br />--------------------<br />type int64 = Int64<br /><br />Full name: Microsoft.FSharp.Core.int64<br /><br />--------------------<br />type int64&lt;&#39;Measure&gt; = int64<br /><br />Full name: Microsoft.FSharp.Core.int64&lt;_&gt;</div>
<div class="tip" id="fs8">val sentences : source:(unit -&gt; string) -&gt; Async&lt;Schema option&gt;<br /><br />Full name: Wordcount.sentences</div>
<div class="tip" id="fs9">val source : (unit -&gt; string)</div>
<div class="tip" id="fs10">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs11">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs12">val splitIntoWords : input:Schema * emit:(Schema -&gt; unit) -&gt; Async&lt;unit&gt;<br /><br />Full name: Wordcount.splitIntoWords</div>
<div class="tip" id="fs13">val input : Schema</div>
<div class="tip" id="fs14">val emit : (Schema -&gt; unit)</div>
<div class="tip" id="fs15">val s : string</div>
<div class="tip" id="fs16">String.Split([&lt;ParamArray&gt;] separator: char []) : string []<br />String.Split(separator: string [], options: StringSplitOptions) : string []<br />String.Split(separator: char [], options: StringSplitOptions) : string []<br />String.Split(separator: char [], count: int) : string []<br />String.Split(separator: string [], count: int, options: StringSplitOptions) : string []<br />String.Split(separator: char [], count: int, options: StringSplitOptions) : string []</div>
<div class="tip" id="fs17">type StringSplitOptions =<br />&#160;&#160;| None = 0<br />&#160;&#160;| RemoveEmptyEntries = 1<br /><br />Full name: System.StringSplitOptions</div>
<div class="tip" id="fs18">field StringSplitOptions.RemoveEmptyEntries = 1</div>
<div class="tip" id="fs19">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs20">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs21">val iter : action:(&#39;T -&gt; unit) -&gt; source:seq&lt;&#39;T&gt; -&gt; unit<br /><br />Full name: Microsoft.FSharp.Collections.Seq.iter</div>
<div class="tip" id="fs22">val failwithf : format:Printf.StringFormat&lt;&#39;T,&#39;Result&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.failwithf</div>
<div class="tip" id="fs23">val countWords : input:Schema * increment:(string -&gt; int64) * emit:(Schema -&gt; unit) -&gt; Async&lt;unit&gt;<br /><br />Full name: Wordcount.countWords</div>
<div class="tip" id="fs24">val increment : (string -&gt; int64)</div>
<div class="tip" id="fs25">val word : string</div>
<div class="tip" id="fs26">val logResult : log:(string -&gt; unit) * input:Schema -&gt; Async&lt;unit&gt;<br /><br />Full name: Wordcount.logResult</div>
<div class="tip" id="fs27">val log : (string -&gt; unit)</div>
<div class="tip" id="fs28">val count : int64</div>
<div class="tip" id="fs29">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs30">val source : (unit -&gt; string)<br /><br />Full name: Wordcount.source</div>
<div class="tip" id="fs31">val rnd : Random</div>
<div class="tip" id="fs32">Multiple items<br />type Random =<br />&#160;&#160;new : unit -&gt; Random + 1 overload<br />&#160;&#160;member Next : unit -&gt; int + 2 overloads<br />&#160;&#160;member NextBytes : buffer:byte[] -&gt; unit<br />&#160;&#160;member NextDouble : unit -&gt; float<br /><br />Full name: System.Random<br /><br />--------------------<br />Random() : unit<br />Random(Seed: int) : unit</div>
<div class="tip" id="fs33">val sentences : string list</div>
<div class="tip" id="fs34">Random.Next() : int<br />Random.Next(maxValue: int) : int<br />Random.Next(minValue: int, maxValue: int) : int</div>
<div class="tip" id="fs35">property List.Length: int</div>
<div class="tip" id="fs36">val increment : (string -&gt; int64)<br /><br />Full name: Wordcount.increment</div>
<div class="tip" id="fs37">val cache : Collections.Concurrent.ConcurrentDictionary&lt;string,int64 ref&gt;</div>
<div class="tip" id="fs38">Multiple items<br />namespace System.Collections<br /><br />--------------------<br />namespace Microsoft.FSharp.Collections</div>
<div class="tip" id="fs39">namespace System.Collections.Concurrent</div>
<div class="tip" id="fs40">Multiple items<br />type ConcurrentDictionary&lt;&#39;TKey,&#39;TValue&gt; =<br />&#160;&#160;new : unit -&gt; ConcurrentDictionary&lt;&#39;TKey, &#39;TValue&gt; + 6 overloads<br />&#160;&#160;member AddOrUpdate : key:&#39;TKey * addValueFactory:Func&lt;&#39;TKey, &#39;TValue&gt; * updateValueFactory:Func&lt;&#39;TKey, &#39;TValue, &#39;TValue&gt; -&gt; &#39;TValue + 2 overloads<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member ContainsKey : key:&#39;TKey -&gt; bool<br />&#160;&#160;member Count : int<br />&#160;&#160;member GetEnumerator : unit -&gt; IEnumerator&lt;KeyValuePair&lt;&#39;TKey, &#39;TValue&gt;&gt;<br />&#160;&#160;member GetOrAdd : key:&#39;TKey * valueFactory:Func&lt;&#39;TKey, &#39;TValue&gt; -&gt; &#39;TValue + 2 overloads<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : &#39;TKey -&gt; &#39;TValue with get, set<br />&#160;&#160;member Keys : ICollection&lt;&#39;TKey&gt;<br />&#160;&#160;...<br /><br />Full name: System.Collections.Concurrent.ConcurrentDictionary&lt;_,_&gt;<br /><br />--------------------<br />Collections.Concurrent.ConcurrentDictionary() : unit<br />Collections.Concurrent.ConcurrentDictionary(collection: Collections.Generic.IEnumerable&lt;Collections.Generic.KeyValuePair&lt;&#39;TKey,&#39;TValue&gt;&gt;) : unit<br />Collections.Concurrent.ConcurrentDictionary(comparer: Collections.Generic.IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Collections.Concurrent.ConcurrentDictionary(concurrencyLevel: int, capacity: int) : unit<br />Collections.Concurrent.ConcurrentDictionary(collection: Collections.Generic.IEnumerable&lt;Collections.Generic.KeyValuePair&lt;&#39;TKey,&#39;TValue&gt;&gt;, comparer: Collections.Generic.IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Collections.Concurrent.ConcurrentDictionary(concurrencyLevel: int, collection: Collections.Generic.IEnumerable&lt;Collections.Generic.KeyValuePair&lt;&#39;TKey,&#39;TValue&gt;&gt;, comparer: Collections.Generic.IEqualityComparer&lt;&#39;TKey&gt;) : unit<br />Collections.Concurrent.ConcurrentDictionary(concurrencyLevel: int, capacity: int, comparer: Collections.Generic.IEqualityComparer&lt;&#39;TKey&gt;) : unit</div>
<div class="tip" id="fs41">Multiple items<br />val ref : value:&#39;T -&gt; &#39;T ref<br /><br />Full name: Microsoft.FSharp.Core.Operators.ref<br /><br />--------------------<br />type &#39;T ref = Ref&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.ref&lt;_&gt;</div>
<div class="tip" id="fs42">val c : int64 ref</div>
<div class="tip" id="fs43">Collections.Concurrent.ConcurrentDictionary.GetOrAdd(key: string, value: int64 ref) : int64 ref<br />Collections.Concurrent.ConcurrentDictionary.GetOrAdd(key: string, valueFactory: Func&lt;string,int64 ref&gt;) : int64 ref<br />Collections.Concurrent.ConcurrentDictionary.GetOrAdd&lt;&#39;TArg&gt;(key: string, valueFactory: Func&lt;string,&#39;TArg,int64 ref&gt;, factoryArgument: &#39;TArg) : int64 ref</div>
<div class="tip" id="fs44">namespace System.Threading</div>
<div class="tip" id="fs45">type Interlocked =<br />&#160;&#160;static member Add : location1:int * value:int -&gt; int + 1 overload<br />&#160;&#160;static member CompareExchange : location1:int * value:int * comparand:int -&gt; int + 6 overloads<br />&#160;&#160;static member Decrement : location:int -&gt; int + 1 overload<br />&#160;&#160;static member Exchange : location1:int * value:int -&gt; int + 6 overloads<br />&#160;&#160;static member Increment : location:int -&gt; int + 1 overload<br />&#160;&#160;static member MemoryBarrier : unit -&gt; unit<br />&#160;&#160;static member Read : location:int64 -&gt; int64<br /><br />Full name: System.Threading.Interlocked</div>
<div class="tip" id="fs46">Threading.Interlocked.Increment(location: byref&lt;int64&gt;) : int64<br />Threading.Interlocked.Increment(location: byref&lt;int&gt;) : int</div>
<div class="tip" id="fs47">Ref.contents: int64</div>
<div class="tip" id="fs48">val sampleTopology : obj<br /><br />Full name: Wordcount.sampleTopology</div>
<div class="tip" id="fs49">val log : value:&#39;T -&gt; &#39;T (requires member Log)<br /><br />Full name: Microsoft.FSharp.Core.Operators.log</div>
<div class="tip" id="fs50">namespace System.Diagnostics</div>
<div class="tip" id="fs51">Multiple items<br />type Process =<br />&#160;&#160;inherit Component<br />&#160;&#160;new : unit -&gt; Process<br />&#160;&#160;member BasePriority : int<br />&#160;&#160;member BeginErrorReadLine : unit -&gt; unit<br />&#160;&#160;member BeginOutputReadLine : unit -&gt; unit<br />&#160;&#160;member CancelErrorRead : unit -&gt; unit<br />&#160;&#160;member CancelOutputRead : unit -&gt; unit<br />&#160;&#160;member Close : unit -&gt; unit<br />&#160;&#160;member CloseMainWindow : unit -&gt; bool<br />&#160;&#160;member EnableRaisingEvents : bool with get, set<br />&#160;&#160;member ExitCode : int<br />&#160;&#160;...<br /><br />Full name: System.Diagnostics.Process<br /><br />--------------------<br />Diagnostics.Process() : unit</div>
<div class="tip" id="fs52">Diagnostics.Process.GetCurrentProcess() : Diagnostics.Process</div>

        </div>
        <div class="span3">
          <img src="/FsShelter/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">FsShelter</li>
            <li><a href="/FsShelter/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/FsShelter">Get Library via NuGet</a></li>
            <li><a href="http://github.com/Prolucid/FsShelter">Source Code on GitHub</a></li>
            <li><a href="/FsShelter/LICENSE.html">License</a></li>
            <li><a href="/FsShelter/RELEASE_NOTES.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started
            <li><a href="/FsShelter/wordcount.html">WordCount topology</a>
			<ul>
			<li><a href="/FsShelter/wordcount.html#Defining-the-schema">Schema</a></li>
            <li><a href="/FsShelter/wordcount.html#Defining-unreliable-spouts">Spout</a></li>
			<li><a href="/FsShelter/wordcount.html#Defining-bolts">Bolt</a></li>
			<li><a href="/FsShelter/wordcount.html#Using-F-DSL-to-define-a-topology">Topology</a></li>
			<li><a href="/FsShelter/wordcount.html#Submitting-the-topology-for-execution">Submitting for execution</a></li>
            <li><a href="/FsShelter/wordcount.html#Exporting-the-topology-graph">Topology graph</a></li>
			</ul>
			</li>
              <li>
                  <a href="/FsShelter/guaranteed.html">Guaranteed processing</a>
                  <ul>
                      <li><a href="/FsShelter/guaranteed.html#Defining-reliable-spouts">Reliable Spout</a></li>
                      <li><a href="/FsShelter/guaranteed.html#Anchoring">Anchoring</a></li>
                  </ul>
              <li><a href="/FsShelter/schema.html">Schema considerations</a></li>
			</li>

            <li class="nav-header">Documentation</li>
            <li><a href="/FsShelter/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/Prolucid/FsShelter"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
